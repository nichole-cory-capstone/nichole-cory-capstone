<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
</head>
<body>
<map class="fluid" th:fragment="map">
<div class="ui hidden divider"></div>
   <div class="ui local search">
   <form id="searchForm" action="">
       <div class="ui left icon input">
           <input id="search-box" type="text" placeholder="Sushi"/>
       </div>
       <button type="submit" id="search-btn" class="ui submit button">SEARCH</button>
       </form>
   </div>
<div id="map"></div>
<button id="more-btn" type="button" class="ui submit button">MORE</button>
<script src="https://apis.google.com/js/platform.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-Fq2UspbtyX0spv_22WGd4ChnxFIQREQ&amp;libraries=places"></script>
<script th:inline="javascript">
      /*<![CDATA[*/
      $(document).ready(function () {
         var latStr = /*[[${collection.latitude}]]*/ '29.426786';
         var lonStr = /*[[${collection.longitude}]]*/ '-98.489576';
             var map;
             var infowindow;
             var service;
             var curLocation = {lat: parseFloat(latStr),
                                lng: parseFloat(lonStr)
                                 };
             var autocompleteOptions = {
                 componentRestrictions: {
                     "country": "us"
                 }
             };
             var getNextPage = null;
             var moreButton = document.getElementById('more-btn');
             moreButton.onclick = function() {
                 $('#more-btn').addClass('loading');
                    // moreButton.disabled = true;
                   if (getNextPage) getNextPage();
             };
             var markers = [];
              var acInput = document.getElementById("autocompleteMap");
              var autocomplete = new google.maps.places.Autocomplete(acInput, autocompleteOptions);

             $('#searchForm').on("submit", function(e){
                 e.preventDefault();
                 console.log("click");
                 var val = $('#search-box').val();
                 $('#search-btn').addClass('loading');
                 search(curLocation,val);
             });

             initMap();
             // getLocation();

             // Bias the autocomplete object to the user's geographical location,
             // as supplied by the browser's 'navigator.geolocation' object.
             function geolocate() {
                 if (navigator.geolocation) {
                     navigator.geolocation.getCurrentPosition(function(position) {
                         var geolocation = {
                             lat: position.coords.latitude,
                             lng: position.coords.longitude
                         };
                         var circle = new google.maps.Circle({
                             center: geolocation,
                             radius: position.coords.accuracy
                         });
                         autocomplete.setBounds(circle.getBounds());
                     });
                 }
             }

             // Geo Location
             function getLocation() {
                 if (navigator.geolocation) {
                     navigator.geolocation.getCurrentPosition(initMap);
                     // $autocomplete.onfocus(geolocate());
                 } else {
                     x.innerHTML = "Geolocation is not supported by this browser.";
                 }
             }

             function initMap() {

                 // $("#wrapper").fadeIn();

                 // var curLocation = {lat: position.coords.latitude, lng: position.coords.longitude};

                 map = new google.maps.Map(document.getElementById('map'), {
                     center: curLocation,
                     zoom: 13
                 });

                 infowindow = new google.maps.InfoWindow();

                 service = new google.maps.places.PlacesService(map);

                 autocomplete.addListener('place_changed', onPlaceChanged);

                 search(curLocation);
             }

             function onPlaceChanged() {
                 $("#wrapper").fadeIn();
                 var place = autocomplete.getPlace();
                 if (place.geometry) {
                     map.panTo(place.geometry.location);
                     map.setZoom(15);
                     clearMarkers();
                     search(place.geometry.location);
                 } else {
                     // acInput.setPlaceholder("Type the city, address or zip code");
                 }
             }

             function search(curLocation,term) {
                 service.nearbySearch({
                     location: curLocation,
                     radius: 1000,
                     type: ['food'],
                     keyword: term
                 }, callback);

             }

             function clearMarkers() {
                 for (var i = 0; i < markers.length; i++) {
                     if (markers[i]) {
                         markers[i].setMap(null);
                     }
                 }
                 markers = [];
             }

             function callback(results, status, pagination) {

                 $('#search-btn').removeClass('loading');
                 $('#more-btn').removeClass('loading');
                 if (status !== 'OK') return;

                 clearMarkers();

                 for (var i = 0; i < results.length; i++) {
                     addMarker(results[i]);
                     }

                 moreButton.disabled = !pagination.hasNextPage;
                 getNextPage = pagination.hasNextPage && function() {
                        pagination.nextPage();
                        };
                 }


             function addMarker(place) {
                 var photos = place.photos;

                 if (!photos) {
                     return;
                 }

                 var photo = photos[0].getUrl({'maxWidth': 150, 'maxHeight': 150});
                 var content = "<h6>" + place.name + "</h6>" +
                     "<br/>" +
                     "<img class='center-align center' src='" + photo + "' /><br/>";

                 var card = '<div class="ui cards">'+
                             '<div class="card">' +
                                '<div class="content">' +
                                  '<div class="header">' + place.name + '</div>' +
                                  '<div class="description">' +
                                  '<img src="' + photo + '"/>' +
                                  '</div>' +
                                '</div>' +
                                '<div class="ui bottom attached button">' +
                                  '<i class="add icon"></i>' +
                                  'Add to your collection' +
                                '</div>' +
                              '</div>';

                 var marker = new google.maps.Marker({
                     map: map,
                     position: place.geometry.location,
                     title: place.name
                     // icon: photos[0].getUrl({'maxWidth': 50, 'maxHeight': 50})
                 });
                 google.maps.event.addListener(marker, 'click', function() {
                     infowindow.setContent(card);
                     infowindow.open(map, this);
                 });


                 markers.push(marker);
             }

             function setMapOnAll(map) {
                 for (var i = 0; i < markers.length; i++) {
                     markers[i].setMap(map);
             }
                 }




         // $('#more-btn').click(function(){
         //     if(pageToken !== null){
         //      $.ajax({
         //              url: "/search/next",
         //              type: "POST",
         //              data: {
         //                  pageToken: pageToken
         //              },
         //              headers: headers
         //          }).done(function (data) {
         //              nearBy = JSON.parse(data);
         //              map.removeMarkers();
         //              addMarkersFromSearch(nearBy.results);
         //              pageToken = nearBy.nextPageToken;
         //              if(pageToken === null){
         //                  $('#more-btn').addClass("disabled")
         //              }
         //          }).fail(function (jqXhr, status, error) {
         //              console.log("Error");
         //          });
         //      }
         // });
      });
       /*]]>*/
</script>
</map>
</body>
</html>
